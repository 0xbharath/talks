
# Pentesting IPv6 networks

---

## Why IPv6 pentesting?

* IPv6 infrastructure adds complexity to a pentest if you don't understand the protocol. <!-- .element: class="fragment" -->
* IPv6 provides interesting opportunities if you understand the protocol.(evading defenses, exploiting flaws) <!-- .element: class="fragment" -->
* Many organizations assume that they don't have IPV6 deployed when infact IPV6 is enabled by default. <!-- .element: class="fragment" -->
* Many organizations that deployed/acknowledge IPv6 have poor IPV6 security measures.<!-- .element: class="fragment" -->

----

## What are we covering?


- Absolute basics of IPv6
- IPv6 attack surface       
- IPv6 tools       
- IPv6 pentesting       
- Building an IPv6 lab

----

## IPV6 attack surface

- Network recon
- Local network attacks
     - Neighbour Discovery attacks.
     - Router related attacks
     - MLD attacks
- Extension header attacks
- Fragmentation attacks
- Evading defense mechanisms 
- Building covert channels

----

## IPV6 tools

- The Hacker Choice's IPv6 Attack Toolkit (aka thc-ipv6)
- The SI6 Networks' IPv6 toolkit
- **Chiron** - an all-in-one IPv6 penetration testing framework
- **Scapy** - powerful packet crafting framework
- Nmap, Metasploit, Wireshark, Ping6, traceroute6.

---

## IPv4 is unsustainable

----

## IPv4 is old 

----

## IPv4 is inefficient

---

## IPv6 is here

----

## What changed in IPv6?

- More efficient address space allocation
- End-to-end addressing; no NAT anymore!
- Fragmentation only by the source host
- Routers do not calculate header checksum (speedup!)
- Multicasting instead of broadcasting
- Built-in security mechanisms
- Single control protocol (ICMPv6)
- Auto-configuration
- Modular headers structure
- Fixed header length

----

![packet_headers](../imgs/ipv4-ipv6-header.gif)

----

## IPV6 address
### 2001:0DB8:0000:0000:0008:8000:0000:417A

Leading 0s are supressed -> 2001:DB8:0:0:8:8000:0:417A <!-- .element: class="fragment" -->

All zero blocks are ommitted, but can be applied only once 2001:DB8::8:8000:0:417A <!-- .element: class="fragment" -->

<br><br><br>

[RFC 4291]

----

- 2001:0DB8:0000:0000:0008:8000:0000:417A
- 2001:DB8:0:0:8:8000:0:417A
- 2001:DB8::8:8000:0:417A
- 2001:DB8:0:0:8:8000::417A
- 2001:db8::8:8000:417A

All of them are valid ways of writing the same IP address!

----

## IPv6 DNS

![dns](../imgs/dns_ipv6.jpg)

----

## IPv6 address types

- Unicast <!-- .element: class="fragment" -->
     - Global
     - Link local
- Anycast <!-- .element: class="fragment" -->
- Multicast <!-- .element: class="fragment" -->

There are no broadcast addresses in IPv6, special multicast addresses are used instead. <!-- .element: class="fragment" -->

----

## IPv6 address classification

- Address prefix matters in IPv6. Addresses are classified based on the prefix.
- Addresses that start with fe80 are link-local unicast addresses(fe80::/10)
- Addresses that start with ff00 are multicast addresses(ff00::/8)

----

## IPv6 special addresses

| Prefix        | Purpose               |
| ------------- |:--------------------: |
| ::/128        | Unspecified           |
| ::1/128       | Loopback              | 
| 2001:db8      | Documentation         |
| fe80::/10     | Linklocal Unicast     |
| ff00::/8      | Multicast             |

[http://www.iana.org/assignments/iana-ipv6-special-registry/iana-ipv6-special-registry.xhtml](http://www.iana.org/assignments/iana-ipv6-special-registry/iana-ipv6-special-registry.xhtml)

----

## IPv6 special multicast addresses

| Address       | Scope         | Use         |
| ------------- |:-------------:| -----------:|
| ff02::1       | Link          | All nodes   |
| ff02::2       | Link          | All routers |
| ff02::5       | Link          | OSPF routers|
| ff02::a       | Link          |EIGRP routers|


[https://en.wikipedia.org/wiki/Multicast_address#IPv6](https://en.wikipedia.org/wiki/Multicast_address#IPv6)

----

### Working with IPv6 addresses

- *`addr6`* tool from SI6's IPv6 toolkit comes handy while dealing with IPv6 addresses

```bash
# Understanding an address
verax@null ~ $ addr6 -a fc00::1024
unicast=unique-local=global=low-byte=unspecified
```

```bash
# Find all the unique addresses in a file
verax@null ~ $ cat list_of_addresses | addr6 -i -q
2001:db8::8:8000:0:417a
2001:a38::8:8000:0:417a
fe80::e8b:fdff:fef4:916
```

```bash
# Filter addresses
verax@null ~ $ cat list_of_addresses | addr6 -i --accept fe80::/64
fe80::e8b:fdff:fef4:916
```

---

## Host discovery on IPV6 networks
<br><br>
[RFC 7707]

----


- An IPv6 address is 128 bits long
- If every IP was completely random without a pattern/prefix the search space would be:

**2^128 = 340,282,366,920,938,000,000,000,000,000,000,000,000**
<br>

**say what!!??** <!-- .element: class="fragment" -->

<br> <br> <!-- .element: class="fragment" -->
But that's not how IPV6 addresses work. IPv6 addresses are logical & hierarchical(even more so than IPv4) <!-- .element: class="fragment" -->

----

## IPv6 address structure


![ipv6_address_authority](../imgs/ipv6_address.png)
![ipv6_address_authority](../imgs/ipv6_address_authority.png)

----

- Each IPv6 subnet has a fixed size.
- Lower 64 bits of an IPv6 address is the Interface ID(IID).
- The search space at this point equals the maximum number of nodes possible per subnet:


**2^64 = 18,446,744,073,709,551,616**

**Brute force scanning is infeasible, to say the least** <!-- .element: class="fragment" -->

If we could find a pattern to the assignment of Interface Identifiers, we could possibly narrow down our search! <!-- .element: class="fragment" -->

----

## Interface Identifier configuration

- Manual configuration
   - Words
   - Last byte 
- Autoconfiguration(SLACC)
   - Modified EUI-64
   - Privacy extensions
- DHCPv6

----

## Wordy IIDs

```bash
verax@null ~ $ host facebook.com
facebook.com has address 157.240.7.35
facebook.com has IPv6 address 2a03:2880:f10c:83:face:b00c:0:25de
facebook.com mail is handled by 10 msgin.vvv.facebook.com.
```
Using words as Interface identifiers

----

## SLACC

Stateless address configuration means that the client picks their own address based on the prefix being advertised on their connected interface(provided by the local router)

----

#### Extended Unique Identifier(EUI-64)

- MAC address is EUI-48.
- An IPv6 address needs 64 bit EUI.

![EUI_64](../imgs/eui_64.png)

----

### Problem with EUI 64 addresses

- FFFE is fixed, reducing the search space to **2^48**.
- OUIs are limited and are publicly available, a clever list of OUIs will reduce the search space to almost **2^24**
- Making matters worse, hardware brought togeather tend to have sequential MAC addresses, reducing the search further. 

----

### Scanning EUI 64 addresses


```bash
verax@null $ sudo scan6 -i vboxnet0 -d 2001:d:0:1::/64 -V vbox -v
Rate-limiting probe packets to 1000 pps (override with the '-r' option if necessary)
Target address ranges (1)
2001:d:0:1:a00:27ff:fe00-feff:0-ffff

Alive nodes:
2001:d:0:1:800:27ff:fe00:0
```

```bash
verax@null $ sudo scan6 -d 2001:d:0:1::/64 -K 'Dell Inc' -v
Rate-limiting probe packets to 1000 pps (override with the '-r' option if necessary)
Target address ranges (32)
2001:d:0:1:f24d:a2ff:fe00-feff:0-ffff
2001:d:0:1:d6be:d9ff:fe00-feff:0-ffff
2001:d:0:1:d6ae:52ff:fe00-feff:0-ffff

... snipped ...

2001:d:0:1:213:72ff:fe00-feff:0-ffff
2001:d:0:1:212:3fff:fe00-feff:0-ffff
2001:d:0:1:211:43ff:fe00-feff:0-ffff

Alive nodes:
^C
```


----

## Big Brother is watching you!

- MAC addresses are globally unique (mostly)
- SLAAC: Modified EUI-64 Interface ID is derived from MAC Users and when moving between networks, network prefixes are changing but interface ID remains constant over time!
- User can be identified and tracked!

----

## Privacy Extensions for SLAAC

- Task: provide privacy for users
- Approach: Random interface ID that changes over time.
- Availability: Enabled by default on most OSs.

[RFC 4941]

----

## Problems with Privacy Extensions

- Privacy extension addresses are assigned alongside EUI 64.
- EUI-64 is used for server purposes, privacy addresses are used for client needs.
- Constantly changing addresses are a network admin nightmare. 

----

### privacy-stability-manageability

![cube](../imgs/cube.png)

[To SLACC or not to SLACC](https://njetwork.wordpress.com/2013/11/03/to-slaac-or-not-to-slaac/)


----

## A solution that works

[RFC 7217] A Method for Generating Semantically Opaque Interface Identifiers with IPv6 Stateless Address Autoconfiguration (SLAAC) 

Basically.. <!-- .element: class="fragment" -->
<br>
Create an IID from network specific data with some crypto which results in an IID that is random, stays the same for a network but changes on a different network. 

----

## Ping link-local nodes

```bash
verax@null ~ $ ping6 -I vboxnet0 ff02::1 | cut -d\  -f4
fe80::800:27ff:fe00:0
fe80::800:27ff:fe00:0
fe80::a00:27ff:fef2:eeae
fe80::a00:27ff:fe3f:3acd
... snipped ...
```

----

## Ping link-local routers

```
verax@null ~ $ ping6 -I vboxnet0 ff02::2 | cut -d\  -f4
fe80::a00:27ff:fef2:eeae:
fe80::a00:27ff:fef2:eeae:
... snipped ...
```

----

### Exploring neighbours with `ip` command

```bash
verax@null ~ $ ip -6 neigh show dev vboxnet0
fe80::a00:27ff:fe3f:3acd lladdr 08:00:27:3f:3a:cd STALE
2001:d:0:1::1 lladdr 08:00:27:f2:ee:ae router REACHABLE
fe80::a00:27ff:fef2:eeae lladdr 08:00:27:f2:ee:ae router STALE
```

----

## Metasploit multicast ping

```bash
msf auxiliary(ipv6_multicast_ping) > run

[*] Sending multicast pings...
[*] Listening for responses...
[*]    |*| fe80::a00:27ff:fe3f:3acd => 08:00:27:3f:3a:cd
[*]    |*| fe80::a00:27ff:fef2:eeae => 08:00:27:f2:ee:ae
[*] Auxiliary module execution completed
```
Module: auxiliary/scanner/discovery/ipv6_multicast_ping

---

## Port scanning IPv6 devices

----
 
### Metasploit port scan

```bash

msf auxiliary(tcp) > run

[*] 2001:d:0:1::1:22 - TCP OPEN
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
Module: auxiliary/scanner/portscan/tcp

----

## Nmap scanning

```bash
verax@null ~ $ nmap -6 -sT -T4 -PN -n 2001:d:0:1::0/126

Starting Nmap 6.40 ( http://nmap.org ) at 2016-12-15 19:43 IST

... snipped ...

Nmap scan report for 2001:d:0:1::1
Host is up (0.00033s latency).
Scanned at 2016-12-15 19:42:01 IST for 0s
Not shown: 999 closed ports
PORT   STATE SERVICE
22/tcp open  ssh

Nmap scan report for 2001:d:0:1::2
Host is up (0.092s latency).
All 1000 scanned ports on 2001:d:0:1::2 are filtered

Nmap scan report for 2001:d:0:1::3
Host is up (0.00031s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

Nmap done: 4 IP addresses (4 hosts up) scanned in 5.35 seconds
```

---

## Building an IPv6 lab


----

## VirtualBox

- VirtualBox supports IPv6 addressing (Host-only, Bridged-wired mode)

----

### Turning a Linux box into IPv6 router
#### Router ADVertisement Daemon(RADVD)

Used to make Linux/BSD act as IPv6 router. It sends Router Advertisement messages as specified by RFC 2461.

```bash
# You have to enable IP forwarding
# Uncomment the following line in /etc/sysctl.conf
net.ipv6.conf.all.forwarding=1
```

```bash
sudo apt-get install radvd     # Install radvd
```

```bash
# Basic radvd config file /etc/radvd.conf
interface eth0
{
   AdvSendAdvert on;
   prefix 2001:db8:0:2::/64
   {
   };
};
```

```bash
sudo service radvd start
```

----

### Configuring radvd

Sample radvd.conf which also advertises DNS servers with RDNSS.

```bash
interface eth0
{
  AdvSendAdvert on;
  MinRtrAdvInterval 3;
  MaxRtrAdvInterval 10;
 
  prefix 2001:db8:0:1::/64
  {
  };
 
  RDNSS 2001:db8:0:1::a 2001:db8:0:1::b
  {
    AdvRDNSSLifetime 10;
  };
};
```


More info at: [tldp.org/HOWTO/Linux+IPv6-HOWTO/](www.tldp.org/HOWTO/Linux+IPv6-HOWTO/)

----

###  ISC DHCP server(DHCPv6)

```bash
sudo apt-get install isc-dhcp-server
```
```bash
ddns-update-style none;
 
default-lease-time 7200;
max-lease-time 86400;
 
subnet6 2001:db8:0:2::/64 {
  range6
    2001:db8:0:2::1000
    2001:db8:0:2::1fff;
 
  option dhcp6.name-servers
    2001:db8:0:1::a,
    2001:db8:0:1::b;
 
  option dhcp6.domain-search
    "koo.fi";
}
```

```bash
sudo service isc-dhcp-server6 start
```
[http://koo.fi/blog/2013/03/20/linux-ipv6-router-radvd-dhcpv6/](http://koo.fi/blog/2013/03/20/linux-ipv6-router-radvd-dhcpv6/)

---

## References

- [http://www.openwall.com/presentations/IPv6/](http://www.openwall.com/presentations/IPv6/)
- [njetwork.wordpress.com/2013/11/03/to-slaac-or-not-to-slaac/](https://njetwork.wordpress.com/2013/11/03/to-slaac-or-not-to-slaac/) <br>
- [https://tools.ietf.org/rfc/rfc7707.txt](https://tools.ietf.org/rfc/rfc7707.txt) <br>
- [internetsociety.org/deploy360/resources/privacy-extensions-for-ipv6-slaac](www.internetsociety.org/deploy360/resources/privacy-extensions-for-ipv6-slaac/) <br>
- [http://koo.fi/blog/2013/03/20/linux-ipv6-router-radvd-dhcpv6](http://koo.fi/blog/2013/03/20/linux-ipv6-router-radvd-dhcpv6/) <br>
- [https://go6.si/wp-content/uploads/2016/06/Fernando-Gont-IPv6-Security.pdf](https://go6.si/wp-content/uploads/2016/06/Fernando-Gont-IPv6-Security.pdf) <br>
- [https://www.si6networks.com/tools/ipv6toolkit/](https://www.si6networks.com/tools/ipv6toolkit/)


---

## Questions?

<br><br>
Twitter.com/yamakira_ <br>
Github.com/yamakira <br>
http://disruptivelabs.in <br>
